{% set os_map = salt['grains.filter_by']({
    'Debian': {
        'pkg_name': 'redis-server',
        'svc_name': 'redis-server',
        'cfg_name': '/etc/redis/redis.conf',
        'cfg_version': salt['grains.filter_by']({
	  'wheezy': '2.4',
	  'jessie': '2.8',
	  'default': '2.8'
	}, grain='oscodename'),
	'logfile': '/var/log/redis/redis-server.log',
        'pidfile': '/var/run/redis-server.pid'
    },
    'RedHat': {
        'pkg_name': 'redis',
        'svc_name': 'redis',
        'cfg_name': '/etc/redis.conf',
        'cfg_version': '2.4',
        'logfile': '/var/log/redis/redis.log',
        'piddfile', '/var/run/redis.pid'
    },
}, merge=salt['pillar.get']('redis:lookup')) %}

{% set redis_settings = {
    'appendfilename': 'appendonly.aof',
    'appendonly': 'no',
    'appendfsync': 'everysec',
    'auto-aof-rewrite-min-size': '64mb',
    'auto-aof-rewrite-percentage': 100,
    'bin': '/usr/local/bin/redis-server',
    'bind': '127.0.0.1',
    'databases': 16,
    'db_dir': '/var/lib/redis';
    'dbfilename': 'dump.rdb',
    'group': 'redis',
    'home': '/var/lib/redis',
    'install_from': 'package',
    'loglevel': 'notice',
    'lua-time-limit': 5000,
    'notify-keyspace-events': '""'',
    'no_apendfsync_on_rewrite': 'no',
    'port': 6379,
    'rdbchecksum': 'yes',
    'rdbcompression': 'yes',
    'repl-disable-tcp-nodelay': 'no',
    'slave-priority': 100,
    'slave-read-only': 'yes'
    'slave-serve-state-data': 'yes',
    'slowlog-max-len': 128,
    'slowlog-log-slower-than': 10000,
    'stop-writes-on-bgsave-error': 'yes',
    'svc_onboot': True,
    'svc_state': 'running',
    'tcp-backlog': 511,
    'tcp_keepalive': 0,
    'user': 'redis'
  }
%}

{# Merge os_map into settings dictionary #}
{% do redis_settings.update(os_map) %}

{# Update settings defaults from pillar data #}
{% do redis_settings.update(salt['pillar.get']('redis', {}) %}
